{
  "name": "LINE Webhook Handler",
  "nodes": [
    {
      "id": "webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "line-webhook",
        "responseMode": "onReceived",
        "responseData": "allEntries"
      }
    },
    {
      "id": "parseEvent",
      "type": "n8n-nodes-base.function",
      "position": [450, 300],
      "parameters": {
        "functionCode": "const events = items[0].json.body.events || [];\nreturn events.map(event => ({ json: event }));"
      }
    },
    {
      "id": "detectIntent",
      "type": "n8n-nodes-base.switch",
      "position": [650, 300],
      "parameters": {
        "dataPropertyName": "message.text",
        "rules": [
          {
            "value": "‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß|‡∏ó‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß|‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß",
            "regex": true,
            "output": 0
          },
          {
            "value": "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô|‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô|bp|BP",
            "regex": true,
            "output": 1
          },
          {
            "value": "‡∏ä‡πà‡∏ß‡∏¢|‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô|‡πÄ‡∏à‡πá‡∏ö|‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å|‡πÅ‡∏ô‡πà‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å",
            "regex": true,
            "output": 2
          }
        ],
        "fallbackOutput": 3
      }
    },
    {
      "id": "logMedication",
      "type": "n8n-nodes-base.supabase",
      "position": [850, 200],
      "parameters": {
        "operation": "insert",
        "table": "medication_logs",
        "columns": "user_id,taken_at",
        "values": "={{$json.source.userId}},={{new Date().toISOString()}}"
      }
    },
    {
      "id": "replyMedication",
      "type": "n8n-nodes-base.httpRequest",
      "position": [1050, 200],
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/reply",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.LINE_CHANNEL_ACCESS_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "replyToken",
              "value": "={{$json.replyToken}}"
            },
            {
              "name": "messages",
              "value": "[{\"type\":\"text\",\"text\":\"‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞\\n‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≤‡∏ô‡∏¢‡∏≤‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤! üíä\"}]"
            }
          ]
        }
      }
    },
    {
      "id": "emergencyAlert",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 400],
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer {{$env.LINE_CHANNEL_ACCESS_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "to",
              "value": "={{$json.caregiverLineId}}"
            },
            {
              "name": "messages",
              "value": "[{\"type\":\"text\",\"text\":\"üö® ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô!\\n{{$json.source.userId}} ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏î‡πà‡∏ß‡∏ô!\"}]"
            }
          ]
        }
      }
    }
  ],
  "connections": {
    "webhook": {
      "main": [["parseEvent"]]
    },
    "parseEvent": {
      "main": [["detectIntent"]]
    },
    "detectIntent": {
      "main": [
        ["logMedication"],
        ["logVitals"],
        ["emergencyAlert"],
        ["aiResponse"]
      ]
    },
    "logMedication": {
      "main": [["replyMedication"]]
    }
  }
}